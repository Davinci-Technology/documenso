apiVersion: apps/v1
kind: Deployment
metadata:
  name: davinci-sign
  namespace: davinci-sign-production
  labels:
    app: davinci-sign
    environment: production
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: davinci-sign
  template:
    metadata:
      labels:
        app: davinci-sign
        environment: production
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      terminationGracePeriodSeconds: 30

      # Init container to create MinIO bucket
      initContainers:
        - name: create-bucket
          image: minio/mc:latest
          command:
            - sh
            - -c
            - |
              echo "Waiting for MinIO to be ready..."
              for i in $(seq 1 60); do
                echo "Attempt $i: Connecting to http://minio:9000..."
                if mc alias set myminio http://minio:9000 davinci-sign "$MINIO_ROOT_PASSWORD"; then
                  echo "MinIO ready! Creating bucket..."
                  mc mb myminio/davinci-sign --ignore-existing
                  echo "Bucket ready!"
                  exit 0
                fi
                echo "MinIO not ready, retrying in 5s..."
                sleep 5
              done
              echo "Failed to connect to MinIO after 60 attempts"
              exit 1
          env:
            - name: MC_CONFIG_DIR
              value: "/tmp/.mc"
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: MINIO_ROOT_PASSWORD

        # Init container to run database migrations
        - name: migrate
          image: davinciai.azurecr.io/davinci-sign:production
          command:
            - npx
            - prisma
            - migrate
            - deploy
            - --schema
            - /app/packages/prisma/schema.prisma
          envFrom:
            - configMapRef:
                name: davinci-sign-config
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: POSTGRES_PASSWORD
            - name: NEXT_PRIVATE_DATABASE_URL
              value: "postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(POSTGRES_DB)?sslmode=$(DB_SSLMODE)"
            - name: NEXT_PRIVATE_DIRECT_DATABASE_URL
              value: "postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(POSTGRES_DB)?sslmode=$(DB_SSLMODE)"

      containers:
        - name: app
          image: davinciai.azurecr.io/davinci-sign:production
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
              name: http

          envFrom:
            - configMapRef:
                name: davinci-sign-config

          env:
            # Database URL constructed from parts
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: POSTGRES_PASSWORD
            - name: NEXT_PRIVATE_DATABASE_URL
              value: "postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(POSTGRES_DB)?sslmode=$(DB_SSLMODE)"
            - name: NEXT_PRIVATE_DIRECT_DATABASE_URL
              value: "postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(POSTGRES_DB)?sslmode=$(DB_SSLMODE)"

            # Secrets from davinci-sign-secrets
            - name: NEXTAUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXTAUTH_SECRET
            - name: NEXT_PRIVATE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXT_PRIVATE_ENCRYPTION_KEY
            - name: NEXT_PRIVATE_ENCRYPTION_SECONDARY_KEY
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXT_PRIVATE_ENCRYPTION_SECONDARY_KEY
            - name: NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY
            - name: NEXT_PRIVATE_SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXT_PRIVATE_SMTP_PASSWORD
            - name: NEXT_PRIVATE_SIGNING_PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: davinci-sign-secrets
                  key: NEXT_PRIVATE_SIGNING_PASSPHRASE

          volumeMounts:
            - name: certificate
              mountPath: /opt/davinci-sign
              readOnly: true

          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "1Gi"
              cpu: "500m"

          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
              httpHeaders:
                - name: Host
                  value: localhost
            initialDelaySeconds: 90
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
              httpHeaders:
                - name: Host
                  value: localhost
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false

      volumes:
        - name: certificate
          secret:
            secretName: davinci-sign-certificate
            items:
              - key: cert.p12
                path: cert.p12
            defaultMode: 0400

      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsUser: 1000

      imagePullSecrets:
        - name: acr-pull-secret
---
apiVersion: v1
kind: Service
metadata:
  name: davinci-sign
  namespace: davinci-sign-production
  labels:
    app: davinci-sign
    environment: production
spec:
  selector:
    app: davinci-sign
  ports:
    - port: 3000
      targetPort: 3000
      name: http
  type: ClusterIP
